{% extends 'base_chat.html' %}
{% load static %}

{% block title %}Edit Slide {{ slide.slide_number }} - {{ presentation.title }} - IntelliHub{% endblock %}

{% block page_title %}
    <i class="fas fa-file-powerpoint mr-2 text-intellihub-primary"></i>
    Edit Slide
{% endblock %}

{% block content %}
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<div class="container mx-auto px-4 py-8" x-data="slideEditor()">
    
    <!-- Breadcrumb Navigation -->
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2 text-gray-400">
            <li><a href="{% url 'presentation_gallery' %}" class="hover:text-blue-400"><i class="fas fa-home mr-1"></i>Presentations</a></li>
            <li><i class="fas fa-chevron-right text-xs"></i></li>
            <li><a href="{% url 'presentation_result' presentation.id %}" class="hover:text-blue-400">{{ presentation.title }}</a></li>
            <li><i class="fas fa-chevron-right text-xs"></i></li>
            <li><a href="{% url 'presentation_edit' presentation.id %}" class="hover:text-blue-400">Edit Presentation</a></li>
            <li><i class="fas fa-chevron-right text-xs"></i></li>
            <li class="text-white">Slide {{ slide.slide_number }}</li>
        </ol>
    </nav>
    
    <!-- Header -->
    <div class="bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur rounded-xl border border-gray-700 p-6 mb-8">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-white mb-2">
                    <i class="fas fa-edit mr-2"></i>
                    Edit Slide {{ slide.slide_number }}
                </h1>
                <p class="text-gray-400">
                    Part of: <span class="text-white font-medium">{{ presentation.title }}</span>
                    <span class="mx-2">•</span>
                    <span class="px-2 py-1 bg-gray-700 rounded text-xs">{{ slide.get_slide_type_display }}</span>
                </p>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <button @click="saveSlide()" 
                        :disabled="saving"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white rounded-lg transition flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    <span x-text="saving ? 'Saving...' : 'Save Slide'"></span>
                </button>
                
                <a href="{% url 'presentation_edit' presentation.id %}" 
                   class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Editor
                </a>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Left Column - Edit Form -->
        <div class="space-y-6">
            
            <!-- Slide Information Card -->
            <div class="bg-gray-800/50 backdrop-blur rounded-xl border border-gray-700 p-6">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-blue-400"></i>
                    Slide Information
                </h2>
                
                <!-- Slide Number -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-hashtag mr-1"></i>
                        Slide Number
                    </label>
                    <div class="px-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white">
                        {{ slide.slide_number }} of {{ presentation.slides.count }}
                    </div>
                </div>
                
                <!-- Slide Type -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-layer-group mr-1"></i>
                        Slide Type
                    </label>
                    <select x-model="slideData.slide_type" 
                            @change="updateSlideTypeDefaults()"
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="title">Title Slide</option>
                        <option value="content">Content Slide</option>
                        <option value="bullet_points">Bullet Points</option>
                        <option value="two_column">Two Column Layout</option>
                        <option value="image_text">Image with Text</option>
                        <option value="chart">Chart/Graph</option>
                        <option value="quote">Quote/Testimonial</option>
                        <option value="call_to_action">Call to Action</option>
                        <option value="thank_you">Thank You/Contact</option>
                        <option value="section_break">Section Break</option>
                    </select>
                </div>
                
                <!-- Layout -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-th-large mr-1"></i>
                        Layout
                    </label>
                    <select x-model="slideData.layout"
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="default">Default Layout</option>
                        <option value="centered">Centered Content</option>
                        <option value="left_aligned">Left Aligned</option>
                        <option value="split_half">Split 50/50</option>
                        <option value="two_thirds_left">Two-thirds Left</option>
                        <option value="two_thirds_right">Two-thirds Right</option>
                        <option value="full_image">Full Background Image</option>
                        <option value="minimal">Minimal Text</option>
                    </select>
                </div>
            </div>
            
            <!-- Content Card -->
            <div class="bg-gray-800/50 backdrop-blur rounded-xl border border-gray-700 p-6">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-align-left mr-2 text-green-400"></i>
                    Content
                </h2>
                
                <!-- Title -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-heading mr-1"></i>
                        Slide Title <span class="text-red-400">*</span>
                    </label>
                    <input type="text" 
                           x-model="slideData.title"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter slide title..."
                           required>
                </div>
                
                <!-- Subtitle (conditional) -->
                <div class="mb-4" x-show="['title', 'section_break'].includes(slideData.slide_type)">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-text-height mr-1"></i>
                        Subtitle
                    </label>
                    <input type="text" 
                           x-model="slideData.subtitle"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter subtitle (optional)...">
                </div>
                
                <!-- Main Content -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-paragraph mr-1"></i>
                        Main Content
                    </label>
                    <textarea x-model="slideData.content"
                              rows="10"
                              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                              placeholder="Enter slide content...

Tips:
- Start lines with '-' for bullet points
- Use blank lines to separate paragraphs
- Use '##' for subheadings"></textarea>
                    
                    <div class="mt-2 flex items-center gap-4 text-xs text-gray-400">
                        <div>
                            <i class="fas fa-info-circle mr-1"></i>
                            <span x-text="`${slideData.content.length} characters`"></span>
                        </div>
                        <div>
                            <span x-text="`${slideData.content.split('\\n').length} lines`"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Speaker Notes -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-sticky-note mr-1"></i>
                        Speaker Notes
                        <span class="text-gray-500 text-xs ml-2">(Not visible in presentation)</span>
                    </label>
                    <textarea x-model="slideData.notes"
                              rows="4"
                              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                              placeholder="Add notes for this slide that will help you during presentation..."></textarea>
                </div>
            </div>
            
            <!-- Styling Card -->
            <div class="bg-gray-800/50 backdrop-blur rounded-xl border border-gray-700 p-6">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-palette mr-2 text-purple-400"></i>
                    Styling
                </h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Background Color -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-fill-drip mr-1"></i>
                            Background
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="color" 
                                   x-model="slideData.background_color"
                                   class="w-12 h-12 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer">
                            <input type="text" 
                                   x-model="slideData.background_color"
                                   class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm font-mono"
                                   placeholder="#ffffff">
                        </div>
                    </div>
                    
                    <!-- Text Color -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-font mr-1"></i>
                            Text Color
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="color" 
                                   x-model="slideData.text_color"
                                   class="w-12 h-12 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer">
                            <input type="text" 
                                   x-model="slideData.text_color"
                                   class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm font-mono"
                                   placeholder="#000000">
                        </div>
                    </div>
                    
                    <!-- Accent Color -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-star mr-1"></i>
                            Accent
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="color" 
                                   x-model="slideData.accent_color"
                                   class="w-12 h-12 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer">
                            <input type="text" 
                                   x-model="slideData.accent_color"
                                   class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm font-mono"
                                   placeholder="#667eea">
                        </div>
                    </div>
                </div>
                
                <!-- Reset Colors Button -->
                <button @click="resetColors()" 
                        class="mt-4 w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded-lg transition">
                    <i class="fas fa-undo mr-2"></i>
                    Reset to Default Colors
                </button>
            </div>
            
        </div>
        
        <!-- Right Column - Live Preview -->
        <div class="space-y-6">
            
            <!-- Preview Card -->
            <div class="bg-gray-800/50 backdrop-blur rounded-xl border border-gray-700 p-6 sticky top-4">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-eye mr-2 text-yellow-400"></i>
                    Live Preview
                    <span class="ml-auto text-xs text-gray-400">Updates in real-time</span>
                </h2>
                
                <!-- Preview Slide -->
                <div class="bg-white rounded-lg shadow-2xl overflow-hidden"
                     style="aspect-ratio: 16/9;">
                    <div class="h-full p-8 flex flex-col"
                         :style="`background-color: ${slideData.background_color || '#ffffff'}; color: ${slideData.text_color || '#000000'}`">
                        
                        <!-- Title -->
                        <h1 class="text-3xl font-bold mb-3 border-b-4 pb-2"
                            :style="`border-color: ${slideData.accent_color || '#667eea'}`"
                            x-text="slideData.title || 'Untitled Slide'"></h1>
                        
                        <!-- Subtitle (if applicable) -->
                        <template x-if="slideData.subtitle && ['title', 'section_break'].includes(slideData.slide_type)">
                            <h2 class="text-xl mb-4 opacity-80" x-text="slideData.subtitle"></h2>
                        </template>
                        
                        <!-- Content -->
                        <div class="flex-1 overflow-y-auto">
                            <div x-html="formatPreviewContent(slideData.content)" 
                                 class="prose prose-sm max-w-none"></div>
                        </div>
                        
                        <!-- Slide Number -->
                        <div class="mt-4 text-right text-sm opacity-50">
                            Slide {{ slide.slide_number }}
                        </div>
                    </div>
                </div>
                
                <!-- Preview Info -->
                <div class="mt-4 p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                    <h3 class="text-sm font-semibold text-white mb-2">Preview Information</h3>
                    <div class="space-y-1 text-xs text-gray-300">
                        <div class="flex justify-between">
                            <span>Slide Type:</span>
                            <span class="font-mono" x-text="slideData.slide_type"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Layout:</span>
                            <span class="font-mono" x-text="slideData.layout"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Has Notes:</span>
                            <span x-text="slideData.notes ? 'Yes' : 'No'"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Content Length:</span>
                            <span x-text="`${slideData.content.length} chars`"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-4 grid grid-cols-2 gap-3">
                    <button @click="duplicateSlide()" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition">
                        <i class="fas fa-copy mr-2"></i>
                        Duplicate Slide
                    </button>
                    <button @click="deleteSlide()" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition">
                        <i class="fas fa-trash mr-2"></i>
                        Delete Slide
                    </button>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div x-show="message" 
         x-transition
         @click="message = ''"
         class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg cursor-pointer z-50"
         :class="messageType === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'">
        <i :class="messageType === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
        <span x-text="message"></span>
    </div>
</div>

<script>
function slideEditor() {
    return {
        slideData: {
            title: '{{ slide.title|escapejs }}',
            subtitle: '{{ slide.subtitle|escapejs|default:"" }}',
            content: `{{ slide.content|escapejs|default:"" }}`,
            notes: `{{ slide.notes|escapejs|default:"" }}`,
            slide_type: '{{ slide.slide_type }}',
            layout: '{{ slide.layout }}',
            background_color: '{{ slide.background_color|default:"#ffffff" }}',
            text_color: '{{ slide.text_color|default:"#000000" }}',
            accent_color: '{{ slide.accent_color|default:"#667eea" }}'
        },
        saving: false,
        message: '',
        messageType: 'success',
        
        updateSlideTypeDefaults() {
            const type = this.slideData.slide_type;
            
            // Set helpful defaults based on slide type
            if (type === 'bullet_points' && !this.slideData.content) {
                this.slideData.content = '- First key point\n- Second important point\n- Third critical point\n- Summary or conclusion';
            } else if (type === 'quote' && !this.slideData.content) {
                this.slideData.content = '"Insert your inspiring quote here."\n\n— Author Name';
            } else if (type === 'call_to_action' && !this.slideData.content) {
                this.slideData.content = 'Ready to take action?\n\nContact us today to get started!';
            }
        },
        
        formatPreviewContent(content) {
            if (!content) return '<p class="text-gray-400 italic">No content yet...</p>';
            
            let formatted = content;
            
            // Convert bullet points
            formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/^• (.+)$/gm, '<li>$1</li>');
            
            // Wrap lists
            if (formatted.includes('<li>')) {
                formatted = '<ul class="list-disc list-inside space-y-2 ml-4">' + formatted + '</ul>';
            }
            
            // Convert headings
            formatted = formatted.replace(/^## (.+)$/gm, '<h3 class="text-xl font-semibold mt-4 mb-2">$1</h3>');
            
            // Convert paragraphs
            const lines = formatted.split('\n');
            let inList = false;
            let result = [];
            
            for (let line of lines) {
                if (line.includes('<ul>')) {
                    inList = true;
                    result.push(line);
                } else if (line.includes('</ul>')) {
                    inList = false;
                    result.push(line);
                } else if (inList || line.includes('<li>') || line.includes('<h3>')) {
                    result.push(line);
                } else if (line.trim()) {
                    result.push('<p class="mb-3">' + line + '</p>');
                }
            }
            
            return result.join('\n');
        },
        
        async saveSlide() {
            if (!this.slideData.title.trim()) {
                this.showMessage('Please enter a slide title', 'error');
                return;
            }
            
            this.saving = true;
            
            try {
                const response = await fetch(`/presentations/edit/{{ presentation.id }}/slide/{{ slide.id }}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(this.slideData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showMessage('Slide saved successfully!', 'success');
                    
                    // Optional: Redirect after short delay
                    setTimeout(() => {
                        // window.location.href = "{% url 'presentation_edit' presentation.id %}";
                    }, 1500);
                } else {
                    this.showMessage('Error: ' + (data.error || 'Failed to save'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
            
            this.saving = false;
        },
        
        resetColors() {
            this.slideData.background_color = '#ffffff';
            this.slideData.text_color = '#000000';
            this.slideData.accent_color = '#667eea';
            this.showMessage('Colors reset to defaults', 'success');
        },
        
        async duplicateSlide() {
            if (confirm('Create a duplicate of this slide?')) {
                // Implement duplicate functionality via API
                this.showMessage('Duplicate functionality coming soon!', 'success');
            }
        },
        
        async deleteSlide() {
            if (confirm('Are you sure you want to delete this slide? This action cannot be undone.')) {
                // Implement delete functionality via API
                this.showMessage('Redirecting to delete...', 'success');
                setTimeout(() => {
                    // Redirect to delete endpoint or back to editor
                    window.location.href = "{% url 'presentation_edit' presentation.id %}";
                }, 1000);
            }
        },
        
        showMessage(msg, type = 'success') {
            this.message = msg;
            this.messageType = type;
            
            setTimeout(() => {
                this.message = '';
            }, 4000);
        }
    }
}
</script>

<style>
/* Custom scrollbar for preview */
.overflow-y-auto::-webkit-scrollbar {
    width: 4px;
}

.overflow-y-auto::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
}

.overflow-y-auto::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 2px;
}

/* Smooth color transitions */
input[type="color"] {
    -webkit-appearance: none;
    border: none;
}

input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 0;
}

input[type="color"]::-webkit-color-swatch {
    border: none;
    border-radius: 0.5rem;
}
</style>
{% endblock %}
